name: Sonar Quality Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v2
      with:
        fetch-depth: 0  # Shallow clones should be disabled for better relevancy of analysis
    
    - name: Set up JDK 11
      uses: actions/setup-java@v2
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '16'
    
    - name: Install frontend dependencies
      run: |
        cd front
        npm install
    
    - name: Run frontend tests with coverage
      run: |
        cd front
        npm run test -- --no-watch --browsers=ChromeHeadless --code-coverage
      continue-on-error: true  # Pour ne pas bloquer l'analyse Sonar si les tests échouent
    
    # Créer le fichier sonar.properties au niveau racine
    - name: Create sonar.properties
      run: |
        cat > sonar-project.properties << 'EOF'
        # Configuration globale
        sonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
        sonar.organization=${{ secrets.SONAR_ORGANIZATION }}
        sonar.host.url=https://sonarcloud.io
        
        # Configuration source
        sonar.sources=back/src/main,front/src
        sonar.tests=back/src/test,front/src/app/**/*.spec.ts
        sonar.sourceEncoding=UTF-8
        
        # Configuration Java
        sonar.java.source=11
        sonar.java.binaries=back/target/classes
        sonar.java.test.binaries=back/target/test-classes
        sonar.jacoco.reportPaths=back/target/jacoco.exec
        sonar.java.coveragePlugin=jacoco
        
        # Configuration TypeScript
        sonar.typescript.lcov.reportPaths=front/coverage/lcov.info
        sonar.javascript.lcov.reportPaths=front/coverage/lcov.info
        
        # Exclusions
        sonar.exclusions=**/node_modules/**,**/*.spec.ts,**/target/classes/static/**
        sonar.coverage.exclusions=**/*.spec.ts,**/test/**
        EOF
    
    # Exécuter les tests backend avec Maven et générer le rapport JaCoCo
    - name: Build and test backend with coverage
      run: |
        cd back
        mvn clean verify jacoco:report
    
    # Analyse SonarCloud 
    - name: Setup scanner
      run: |
        mkdir -p $HOME/.sonar
        
        # Télécharger le scanner SonarCloud pour Maven
        mvn org.sonarsource.scanner.maven:sonar-maven-plugin:3.9.1.2184:help
        
        # Afficher le fichier de configuration pour déboguer
        cat sonar-project.properties
    
    - name: Run SonarCloud analysis
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        cd back
        mvn sonar:sonar \
          -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
          -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
          -Dsonar.host.url=https://sonarcloud.io
name: CI/CD Pipeline

on:
  workflow_call:
  workflow_dispatch:

jobs:
  build-and-deploy:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    # Configuration Java
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
        cache: maven
    
    # Configuration Node.js
    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'
        cache: 'npm'
        cache-dependency-path: './front/package-lock.json'
    
    # Build Backend
    - name: Build Backend
      run: |
        cd back
        mvn clean install
    
    # Build Frontend
    - name: Build Frontend
      run: |
        cd front
        npm install
    
    # Build Docker images
    - name: Build Docker images
      run: |
        # Build frontend Docker image
        echo "Building Frontend Docker image..."
        cd front
        docker build -t bobapp-front .
        
        # Build backend Docker image
        echo "Building Backend Docker image..."
        cd ../back
        docker build -t bobapp-back .
    
    # Test Docker images locally
    - name: Test Docker containers
      run: |
        # Démarrer le conteneur frontend
        docker run -p 8080:8080 --name bobapp-front -d bobapp-front
        echo "Frontend container started on port 8080"
        
        # Démarrer le conteneur backend
        docker run -p 9080:8080 --name bobapp-back -d bobapp-back
        echo "Backend container started on port 9080"
        
        # Vérifier que les conteneurs sont en cours d'exécution
        docker ps
        
        # Nettoyer les conteneurs après le test
        docker stop bobapp-front bobapp-back
        docker rm bobapp-front bobapp-back
    
    # Notification du statut
    - name: Build status
      run: |
        echo "Build and container test: COMPLETED"